var sad_objects = new Array();
var sad_modes = new Array();
var sad_ids = new Array();
var sad_idx = 0;
var sad_baseurl = (function() {
	var re = new RegExp('js/sad-jsonp(\.min)?\.js.*'),
	scripts = document.getElementsByTagName('script');
	for (var i = 0, ii = scripts.length; i < ii; i++) {
		var path = scripts[i].getAttribute('src');
		if(re.test(path)) return path.replace(re, '');
	}
})();

jQuery(document).ready(function() {
	sad_init();
});

function sad_init() {
	var sad_boxes = jQuery("div.sad-box");
	jQuery.each(sad_boxes, function() {
		var mode = jQuery(this).attr("data-mode");
		if (!mode) mode = "";
		sad_modes[sad_idx] = mode;
		var id = jQuery(this).attr("data-id");
		sad_ids[sad_idx] = id;
		sad_objects[sad_idx] = this;
		sad_idx++;
	});
	if (sad_idx > 0) sad_getbox(0);
}

function sad_getbox(idx) {
	var action = sad_baseurl + "ajax.php";
	jQuery.ajax({
		url: action, 
		data: {
			"mode": 	sad_modes[idx],
			"id": 		sad_ids[idx],
			"action":	"sad_getbox"
		},
		dataType: "jsonp",
		success: function(data) {
			var html_data = data.html;
			if(html_data.match("sad_box") != null) {
				jQuery(sad_objects[idx]).css("display", "none");
				jQuery(sad_objects[idx]).append(html_data);
				jQuery(sad_objects[idx]).slideDown(600);
			}
			if (idx+1 < sad_idx) {
				sad_getbox(idx+1);
			}
		}
	});
}

var sad_suffix = "";
var sad_busy = false;
function sad_submit(suffix) {
	if (sad_busy == true) return;
	sad_busy = true;
	sad_suffix = suffix;
	jQuery("#sad_submit"+sad_suffix).attr("disabled","disabled");
	jQuery("#sad_loading"+sad_suffix).fadeIn(300);
	jQuery("#sad_message"+sad_suffix).slideUp("slow");
	jQuery.ajax({
		url: sad_baseurl + "ajax.php", 
		data: {
			"name":		jQuery("#name"+suffix).val(),
			"email":	jQuery("#email"+suffix).val(),
			"id":		jQuery("#file"+suffix).val(),
			"suffix":	suffix,
			"action":	"sad_submit"
		},
		dataType: "jsonp",
		success: function(data) {
			var html_data = data.html;
			jQuery("#sad_loading"+sad_suffix).fadeOut(200);
			jQuery("#sad_submit"+sad_suffix).removeAttr("disabled");
			if(html_data.match("sad_confirmation_info") != null) {
				jQuery("#sad_signup_form"+sad_suffix).fadeOut(500, function() {
					jQuery("#sad_confirmation_container"+sad_suffix).html(html_data);
					jQuery("#sad_confirmation_container"+sad_suffix).fadeIn(500, function() {});
				});
			} else {
				jQuery("#sad_message"+sad_suffix).html(html_data);
				jQuery("#sad_message"+sad_suffix).slideDown("slow");
			}
			sad_busy = false;
		}
	});
}